name: Selenium PHP Automation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-suite:
    runs-on: ubuntu-latest # Usamos una máquina virtual Linux (Ubuntu)

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer

    - name: Install Dependencies
      run: composer install --prefer-dist --no-progress

    # 4. Instalar Google Chrome (Navegador)
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    # 5. Descargar e Iniciar ChromeDriver (El conductor)
    - name: Start ChromeDriver
      run: |
        echo "Detectando versión de Chrome..."
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
        echo "Chrome Version: $CHROME_VERSION"
        
        echo "Descargando ChromeDriver..."
        # URL genérica para descargar drivers de prueba de Google
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/127.0.6533.72/linux64/chromedriver-linux64.zip" -O chromedriver.zip
        unzip chromedriver.zip
        
        echo "Iniciando ChromeDriver en puerto 4444..."
        # El símbolo '&' al final ejecuta el proceso en segundo plano para no bloquear el script
        ./chromedriver-linux64/chromedriver --port=4444 &
        
        echo "Esperando a que ChromeDriver esté listo..."
        sleep 5

    # 6. Ejecutar los Tests
    - name: Run PHPUnit Tests
      run: vendor/bin/phpunit tests/SauceDemoTest.php

    # 7. Subir reportes y capturas de pantalla (Artifacts)
    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots
        path: target/screenshots/
        retention-days: 5
